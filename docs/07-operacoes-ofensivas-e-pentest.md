# 07. Operações Ofensivas e Pentest

Operações ofensivas profissionais exigem planejamento meticuloso, execução disciplinada e documentação impecável. Este capítulo aprofunda a metodologia, destacando planejamento operacional, infraestrutura de campanha, ferramentas de exploração, pós-exploração avançada e evasão de defesas modernas.

## 7.1 Planejamento estratégico
### 7.1.1 Frameworks e governança
- **Kill Chain (Lockheed Martin)**: Reconhecimento → Armazenamento → Entrega → Exploração → Instalação → Comando & Controle → Ações.
- **MITRE ATT&CK**: mapeie técnicas usadas em cada fase, defina TTPs a testar.
- **Diamond Model**: relaciona adversário, infraestrutura, capability e vítima.
- Documente escopo, limitações, janelas de operação, contatos de emergência e regras de engajamento (ROE). Use `docs/07` para armazenar templates.

### 7.1.2 Infraestrutura e opsec
- **Infra de comando**: VPS, cloud, bulletproof hosting. Configure DNS, certificados TLS, C2 (Sliver, Mythic, Covenant, Cobalt Strike). Use domínios plausíveis.
- **Infra de phishing**: GoPhish, Modlishka, King Phisher. Configure SPF/DKIM/DMARC para aumentar entregabilidade.
- **Logística**: `burner` accounts, eSIMs, proxies (Tor, VPN multi-hop), `domain fronting` se permitido.
- **OPSEC**: use contas separadas, criptografe PBIs, evite reutilizar payloads. Defina política de logs (o que registrar, quando apagar).

## 7.2 Reconhecimento avançado
- **Passive Recon**: OSINT, `theHarvester`, `SpiderFoot`, `Recon-ng`, `Shodan`, `GreyNoise`, `SecurityTrails`.
- **Active Recon**:
  - DNS enumerations (zonetransfer.me, `AXFR`, `axfr.py`).
  - HTTP: `aquatone`, `gowitness` para screenshots.
  - Cloud: `enumerate-iam` (AWS), `gnmap` de `AzureHound`, `GCP` enumerations via APIs.
- **Social Engineering**: gather data de LinkedIn, GitHub, redes sociais. Use `sherlock`, `maigret`.

## 7.3 Exploração aprofundada
### 7.3.1 Infraestrutura C2
- **Sliver**: open source, TLS mutual auth, profiles. Use `sliver server`, `profiles new beacon`.
- **Mythic**: C2 modular com operadores e payloads customizados (Apollo, Poseidon). Integre com containers Docker.
- **Havoc**, **Covenant**: alternativas com foco em evasão.

### 7.3.2 Privesc avançado
- Linux: `linpeas`, `lse`, `beRoot`, abusos de `sudo`, `capabilities`, cronjobs, `kernel exploits`.
- Windows: `SharpHound`, `Seatbelt`, `PowerUp`, `SafetyKatz`, `PrintSpoofer`.
- Kerberos: `kerberoasting`, `AS-REP roasting`, `S4U`, `Delegação Constrangida`, `ADCS abuse` (`certsrv`).
- Contêineres: `docker.sock`, `cgroup` escapes, `dirty pipe`.

### 7.3.3 Engenharia social
- **Phishing**: e-mails, SMS (`smali`, `gophish`), voice (Vishing). Scripts de pretexto.
- **Ataques físicos**: drop de USB, implant devices (`LAN Turtle`, `Bash Bunny`). Documente riscos e autorização.

## 7.4 Pós-exploração e persistência
- **Coleta**: credenciais (LSASS, DPAPI, Chrome/Firefox), tokens cloud, secrets managers.
- **Movement**: `BloodHound` + `Neo4j` para análise gráfica, `CrackMapExec` para autenticação em massa, `Rubeus` (Kerberos tokens).
- **Persistência**: `schtasks`, `WMI`, `GPO`, `RunKeys`, backdoors em serviços, `LD_PRELOAD`, `systemd` units ocultas (`[Install] WantedBy=multi-user.target` com `Alias`).
- **Evasão**: desabilitar EDR? (Somente com autorização). Prefira `living-off-the-land` (LOLBins). Use `AMSIFix`, `Invoke-Obfuscation`.

## 7.5 Pós-operacional
- **Exfiltração**: `rclone`, `scp`, `DNS/ICMP tunnel`, `cloud storage`. Sempre use criptografia (GPG, zip AES) e compressão.
- **Anti-forense** (apenas em laboratórios controlados): `timestomping`, `log tampering` (com autorização). Documente cuidadosamente.
- **Lições aprendidas**: compile indicadores (hashes, domínios, IPs), privesc, impacto, recomendações.

## 7.6 Automação ofensiva
- Scripts em `playbooks/`: pipelines `AutoRecon`, `Sliver`, `BloodHound` custom.
- `Mythic C2` e `Sliver` suportam scripting (Go, Python). Desenvolva payloads customizados (implant) com melhora de opsec.
- Integração com `GitLab CI` para automação de scans (foco em descoberta externa). Use gating para evitar execução fora de janela.

## 7.7 Evasão e detecção
- Use `Invoke-EDRChecker` para mapear defesas.
- `Seatbelt`, `SharpUp`, `PEASS` enumeram EDR/AV.
- `Donut`, `sRDI` convertem executáveis em shellcode para injeção refletiva.
- Para Kali, utilize `obfuscator-llvm` para compilar payloads custom com menos detecção.

## 7.8 Reportando resultados
- Relatório técnico: detalha vulnerabilidade, PoC, passos, evidências.
- Relatório executivo: impactos, priorização, roadmap.
- Adote frameworks como OWASP Risk Rating, CVSS, DREAD.
- Use `Mermaid`, `draw.io` para diagramas de ataque.
- Deixe repositório organizado (`labs/artifacts/pentest-YYYYMMDD`).

## 7.9 Estudo de caso: ataque híbrido
1. Recon passivo -> coleta de subdomínios -> identificação de portal OWA.
2. Campanha de spear phishing obtém credenciais, bypass 2FA com Evilginx.
3. Acesso VPN, entrada na rede interna.
4. `BloodHound` revela privesc via delegação direta.
5. Persistência em `services.exe` modificado. Exfiltração de dados via S3.
6. Documentação com ATT&CK mapping, recomendações (MFA resistente a phishing, hardening de delegação, monitoramento `event ID 4769`).

## 7.10 Exercícios avançados
1. Monte infra C2 (Sliver) com domain fronting. Gere payload HTTP/2, execute em laboratório e monitore detecção (cap. 05).
2. Desenvolva campanha GoPhish com landing page custom. Documente métricas (entregas, cliques, credenciais) e defina plano de resposta.
3. Execute `BloodHound` em lab AD, identifique quatro caminhos de privesc distintos, teste ao menos dois e registre mitigação.
4. Crie relatório completo (técnico + executivo) para operação fictícia, com evidências (screenshots, PCAP). Compare com template `templates/relatorio-pentest.md`.

> **Referências:** *Red Team Development and Operations* (Joe Vest), *The Hacker Playbook* série, *Adversary Emulation Plan* (MITRE), blogs SpecterOps, Black Hills InfoSec.
